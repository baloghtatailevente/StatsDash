<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tranzakció Napló - Sorverseny</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/base.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
</head>

<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg bg-secondary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><img src="/img/logo.png" alt="Logo" width="60" height="55"
                    class="d-inline-block align-text-top"></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="/dashboard">Kezdőlap</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link perm-0" href="/dashboard/station?id=xyz">Állomás</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link perm-1" href="/dashboard/players">Játékosok</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link perm-99" href="/dashboard/players">Játékosok</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link perm-99" href="/dashboard/admin/users">Felhasználók</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link perm-99" href="/dashboard/admin/stations">Állomások</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link perm-99" href="/dashboard/admin/statisztika">Statisztika</a>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle perm-99 text-light" href="#" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            Napló
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/dashboard/admin/login-logs">Azonosítási Napló</a></li>

                            <li><a class="dropdown-item disabled" href="/dashboard/admin/points-logs">Tranzakció
                                    Napló</a></li>
                        </ul>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link perm-99" href="/dashboard/system">Rendszer</a>
                    </li>
                </ul>
                <button class="btn btn-light" id="logout" onclick="logout()">Kijelentkezés</button>
            </div>
        </div>
    </nav>
    <div class="container my-3">
        <div class="row">
            <div class="col-md-6 mx-auto">
                <div class="form-floating">
                    <input type="text" id="searchInput" class="form-control"
                        placeholder="Keresés név, felhasználónév vagy e-mail alapján..." />
                    <label for="searchInput">Keresés név, sorszám, állomás, dátum vagy pont alapján...</label>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-center mb-3">
        <div class="col-md-3 text-center">
            <button class="btn btn-outline-danger w-100" id="addTransBtn">Azonosítás szükséges!</button>
        </div>
        <div class="col-md-3 text-center">
            <button class="btn btn-primary w-100 ms-3" id="addTransBtn">Érvényesítés</button>
        </div>
    </div>
    <!-- PLAYERS TABLE -->
    <table class="table">
        <thead>
            <tr>
                <th>#</th>
                <th>Név</th>
                <th>Szám</th>
                <th>Osztály</th>
                <th>Állomás</th>
                <th>∑</th> <!-- ÚJ OSZLOP -->
                <th>Dátum</th>
                <th class="perm-99">Műveletek</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="8">Betöltés...</td>
            </tr>
        </tbody>
    </table>

    <!-- ADD TRANSACTION MODAL (Azonosítás) -->
    <div class="modal fade" id="authModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Azonosítás</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger d-none" id="badAuthCodeAlert">Hibás főszervezői kód</div>
                    <p class="text-danger">Főszervezői jogosultság szükséges a műveletek feloldásához!</p>
                    <form id="addPlayerForm">
                        <div class="mb-3">
                            <label for="authCode" class="form-label">Kód</label>
                            <input type="password" class="form-control" id="authCode">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button>
                    <button class="btn btn-success" onclick="authAccessCode()">Ellenőrzés</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Érvényesítés Modal -->
    <div class="modal fade" id="checkModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Érvényesítés</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger d-none" id="badAuthCodeAlert">Hibás főszervezői kód</div>
                    <p class="text-danger">Főszervezői jogosultság szükséges az adatok ellenőrzéséhez és érvényesítéséhez!</p>
                    <form id="addPlayerForm">
                        <div class="mb-3">
                            <label for="authCode" class="form-label">Kód</label>
                            <input type="password" class="form-control" id="authCode">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT PLAYER MODAL -->
    <div class="modal fade" id="editPlayerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Játékos szerkesztése</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editPlayerForm">
                        <input type="hidden" id="editPlayerId">
                        <div class="mb-3">
                            <label for="editName" class="form-label">Név</label>
                            <input type="text" class="form-control" id="editName">
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label for="editClass" class="form-label">Osztály</label>
                                <input type="text" class="form-control" id="editClass">
                            </div>
                            <div class="col">
                                <label for="editNumber" class="form-label">Szám</label>
                                <input type="text" class="form-control" id="editNumber">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editPoints" class="form-label">Pontok</label>
                            <input type="number" class="form-control" id="editPoints">
                        </div>
                        <div class="mb-3">
                            <label for="editLastStation" class="form-label">Utolsó állomás</label>
                            <input type="text" class="form-control" id="editLastStation" placeholder="-" disabled>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button>
                    <button class="btn btn-primary" onclick="savePlayer()">Mentés</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jQuery (required by bootstrap-select) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap Select JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>


    <script>
        $('.selectpicker').selectpicker();

        document.addEventListener("DOMContentLoaded", function () {
            new bootstrap.Modal(document.getElementById("checkModal")).show();
        });

        document
            .getElementById("searchInput")
            .addEventListener("input", function (e) {
                const query = e.target.value.toLowerCase();
                const rows = document.querySelectorAll("table tbody tr");
                rows.forEach((row) => {
                    const cells = Array.from(row.querySelectorAll("td")).map((td) =>
                        td.textContent.toLowerCase()
                    );
                    const match = cells.some((text) => text.includes(query));
                    row.style.display = match ? "" : "none";
                });
            });

        async function authAccessCode() {
            const addTransBtn = document.getElementById("addTransBtn")

            const code = document.getElementById("authCode").value
            const res = await fetch(`/api/auth/accesscode?code=${code}`)
            if (res.status === 202) {
                accessGranted = true
                fetchPlayers()
                document.getElementById("badAuthCodeAlert").classList.add("d-none")
                bootstrap.Modal.getInstance(document.getElementById("authModal")).hide();
                addTransBtn.classList.remove("btn-outline-danger")
                addTransBtn.classList.add("btn-success")
                addTransBtn.innerText = "+ Új tranzakció"
            } else {
                accessGranted = false
                document.getElementById("badAuthCodeAlert").classList.remove("d-none")
                code = ""
            }
        }


        // --- FETCH PLAYERS ---
        async function fetchPlayers(query = "") {
            try {
                const res = await fetch('/api/logs/points');
                let logs = await res.json();
                console.log(logs)
                if (query) {
                    const q = query.toLowerCase();
                    logs = logs.filter(p =>
                        (p.name || "").toLowerCase().includes(q) ||
                        (p.class || "").toLowerCase().includes(q) ||
                        (p.number || "").includes(q) ||
                        (p.point || "").includes(q)
                    );
                }

                const res2 = await fetch('/api/players');
                let players = await res2.json();
                console.log(players)

                const res3 = await fetch('/api/stations')
                let stations = await res3.json()
                console.log(stations)

                const tbody = document.querySelector("table tbody");
                tbody.innerHTML = "";
                logs.forEach((p, i) => {
                    const player = players.find(plr => plr._id === p.user);
                    const station = stations.find(st => st._id === p.station)
                    // console.log("Station: " + station)
                    // console.log("Datas: " + station.name)
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                <th>${i + 1}</th>
                <td>${player.name || "Ismeretlen"}</td>
                <td>#${player.number || "-"}</td>
                <td>${player.class || "-"}</td>
                <td>${station.name || "-"}</td>
                <td>${p.points ?? 0}</td> <!-- ÚJ -->
                <td>${new Date(p.timestamp).toLocaleString("hu-HU") || '-'}</td>
                <td>
                    <div class="btn-group perm-99">
                        <button class="btn btn-outline-success" onclick="openEditModal('${p._id}')">
                            <span class="material-symbols-outlined">more_horiz</span>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deletePlayer('${p._id}')">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                </td>
            `;
                    tbody.appendChild(tr);
                });

                init()
            } catch (err) { console.error(err); }
        }
        // --- SEARCH ---


        async function addPlayer() {
            const payload = {
                name: document.getElementById("addName").value,
                class: document.getElementById("addClass").value,
                number: document.getElementById("addNumber").value,
            };
            try {
                const res = await fetch("/api/players", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok) return alert(data.message || "Hiba");
                fetchPlayers();
                bootstrap.Modal.getInstance(document.getElementById("addPlayerModal")).hide();
                document.getElementById("addPlayerForm").reset();
            } catch (err) { console.error(err); alert("Hálózati hiba"); }
        }

        // --- EDIT PLAYER ---
        let currentPlayerId = null;
        function openEditModal(id) {
            fetch('/api/players').then(r => r.json()).then(players => {
                const p = players.find(pl => pl._id === id);
                if (!p) return;
                currentPlayerId = id;
                document.getElementById("editPlayerId").value = id;
                document.getElementById("editName").value = p.name;
                document.getElementById("editClass").value = p.class;
                document.getElementById("editNumber").value = p.number;
                document.getElementById("editPoints").value = p.points ?? 0;
                document.getElementById("editLastStation").value = p.last_station || "";
                new bootstrap.Modal(document.getElementById("editPlayerModal")).show();
            });
        }


        async function savePlayer() {
            const id = document.getElementById("editPlayerId").value;
            const payload = {
                name: document.getElementById("editName").value,
                class: document.getElementById("editClass").value,
                number: document.getElementById("editNumber").value,
                points: parseInt(document.getElementById("editPoints").value) || 0,
                last_station: document.getElementById("editLastStation").value
            };
            try {
                const res = await fetch(`/api/players/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok) return alert(data.message || "Hiba");
                fetchPlayers();
                bootstrap.Modal.getInstance(document.getElementById("editPlayerModal")).hide();
            } catch (err) { console.error(err); alert("Hálózati hiba"); }
        }

        // --- DELETE PLAYER ---
        async function deletePlayer(id) {
            if (!confirm("Biztosan törlöd a játékost?")) return;
            try {
                const res = await fetch(`/api/players/${id}`, { method: "DELETE" });
                const data = await res.json();
                alert(data.message);
                fetchPlayers();
            } catch (err) { console.error(err); alert("Hiba törlésnél"); }
        }

        // --- INITIAL FETCH ---
        fetchPlayers();
    </script>

    <script src="/js/auth99.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>