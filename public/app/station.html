<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Állomás - Sorverseny</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="base.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
</head>

<body>
    <div class="position-fixed top-50 start-0 translate-middle-y ms-3">
        <h4>Státusz</h4>
        <div class="btn-group-vertical mr-3" role="group">
            <input type="radio" class="btn-check" name="vbtn-radio" id="vbtn-radio1" autocomplete="off">
            <label class="btn btn-outline-danger" for="vbtn-radio1"><span class="material-symbols-outlined">
                    lock
                </span></label>
            <input type="radio" class="btn-check" name="vbtn-radio" id="vbtn-radio2" autocomplete="off">
            <label class="btn btn-outline-success" for="vbtn-radio2"><span class="material-symbols-outlined">
                    lock_open
                </span></label>
        </div>
    </div>

    <main class="d-flex align-items-center justify-content-center py-5 mt-5">
        <div class="text-center w-100" style="max-width:420px; position:relative;">
            <!-- Header -->
            <h4 class="fw-bold mb-1">Állomás: <span id="stationName">Betöltés</span> (#<span id="stationId">???</span>)
            </h4>
            <p class="text-muted mb-4" id="msg">Kérem várjon!</p>

            <!-- Keypad -->
            <div class="container px-0" id="keypad-container" style="position:relative;">
                <!-- Overlay for closed station -->
                <div id="keypad-closed-overlay"
                    style="display:none; position:absolute; z-index:10; top:0; left:0; width:100%; height:100%; background:rgba(255,0,0,0.35); pointer-events:none; align-items:center; justify-content:center; flex-direction:column; border-radius: 10px;"
                    class="border border-danger border-2">
                    <svg width="100%" height="100%" viewBox="0 0 300 380" style="position:absolute;top:0;left:0;">
                        <line x1="25" y1="40" x2="275" y2="340" stroke="red" stroke-width="18" stroke-linecap="round" />
                        <line x1="275" y1="40" x2="25" y2="340" stroke="red" stroke-width="18" stroke-linecap="round" />
                    </svg>
                </div>
                <!-- Use rows of 3 columns. Each column is a d-grid to make button expand to full column width. -->
                <input type="text" class="form-control border mb-5 text-center" id="code">
                <div class="row g-3">
                    <!-- Row 1 -->
                    <div class="col-4 d-grid">
                        <button type="button"
                            class="btn btn-light rounded-pill py-4 fs-4 shadow-sm keypad-btn">1</button>
                    </div>
                    <div class="col-4 d-grid">
                        <button type="button"
                            class="btn btn-light rounded-pill py-4 fs-4 shadow-sm keypad-btn">2</button>
                    </div>
                    <div class="col-4 d-grid">
                        <button type="button"
                            class="btn btn-light rounded-pill py-4 fs-4 shadow-sm keypad-btn">3</button>
                    </div>

                    <!-- Row 2 -->
                    <div class="col-4 d-grid">
                        <button type="button"
                            class="btn btn-light rounded-pill py-4 fs-4 shadow-sm keypad-btn">4</button>
                    </div>
                    <div class="col-4 d-grid">
                        <button type="button"
                            class="btn btn-light rounded-pill py-4 fs-4 shadow-sm keypad-btn">5</button>
                    </div>
                    <div class="col-4 d-grid">
                        <button type="button"
                            class="btn btn-light rounded-pill py-4 fs-4 shadow-sm keypad-btn">6</button>
                    </div>

                    <!-- Row 3 -->
                    <div class="col-4 d-grid">
                        <button type="button"
                            class="btn btn-light rounded-pill py-4 fs-4 shadow-sm keypad-btn">7</button>
                    </div>
                    <div class="col-4 d-grid">
                        <button type="button"
                            class="btn btn-light rounded-pill py-4 fs-4 shadow-sm keypad-btn">8</button>
                    </div>
                    <div class="col-4 d-grid">
                        <button type="button"
                            class="btn btn-light rounded-pill py-4 fs-4 shadow-sm keypad-btn">9</button>
                    </div>

                    <!-- Row 4 (check, 0, back) -->
                    <div class="col-4 d-grid">
                        <button type="button" class="btn btn-light rounded-pill py-3 fs-4 shadow-sm"
                            id="confirmBtn">✓</button>
                    </div>
                    <div class="col-4 d-grid">
                        <button type="button"
                            class="btn btn-light rounded-pill py-4 fs-4 shadow-sm keypad-btn">0</button>
                    </div>
                    <div class="col-4 d-grid">
                        <button type="button" class="btn btn-light rounded-pill py-3 fs-4 shadow-sm"
                            id="backBtn">⌫</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="position-fixed top-50 end-0 translate-middle-y me-3">
        <h4>V. Idő</h4>
        <div class="btn-group-vertical" role="group">
            <input type="radio" class="btn-check" name="delay-radio" id="delay-0" value="0" autocomplete="off">
            <label class="btn btn-outline-warning" for="delay-0"><span
                    class="material-symbols-outlined">timer_off</span></label>

            <input type="radio" class="btn-check" name="delay-radio" id="delay-5" value="5" autocomplete="off">
            <label class="btn btn-outline-warning" for="delay-5">5p</label>

            <input type="radio" class="btn-check" name="delay-radio" id="delay-10" value="10" autocomplete="off">
            <label class="btn btn-outline-warning" for="delay-10">10p</label>

            <input type="radio" class="btn-check" name="delay-radio" id="delay-15" value="15" autocomplete="off">
            <label class="btn btn-outline-warning" for="delay-15">15p</label>
        </div>
    </div>

    <div class="position-fixed bottom-0 start-0 mb-3 ms-3">
        <a href="./" class="btn btn-success"><span class="material-symbols-outlined">arrow_circle_left</span></a>
    </div>

    <div id="playerInfo" style="
        position: fixed;
        top: 10px;
        left: -250px;
        width: 240px;
        padding: 10px;
        background: rgba(0,123,255,0.9);
        color: white;
        border-radius: 5px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        transition: left 0.5s;
    ">
        <strong id="playerName">Név: -</strong><br>
        <span id="playerNumber">Sorszám: -</span><br>
        <span id="playerClass">Osztály: -</span><br>
        <span id="playerPoints">Pont: -</span>
    </div>

</body>
<script src="/js/auth0.js"></script>
<script>
    const codeInput = document.getElementById("code");
    const keypadButtons = document.querySelectorAll(".keypad-btn");
    const backBtn = document.getElementById("backBtn");
    const confirmBtn = document.getElementById("confirmBtn");
    const delayRadios = document.querySelectorAll('input[name="delay-radio"]');
    const statusRadios = document.querySelectorAll('input[name="vbtn-radio"]');

    let step = 1;
    let currentCode = "";
    let userData = null;
    let stationData = null;

    // Update input field and currentCode
    const updateInput = v => {
        codeInput.value = currentCode = v;
    };

    // Reset to step 1 state
    const resetToStep1 = () => {
        step = 1;
        currentCode = "";
        userData = null;
        codeInput.value = "";
        document.getElementById("msg").innerText = "Kérlek add meg a játékos sorszámát!";
        // Hide the player info div
        document.getElementById("playerInfo").style.left = "-250px";
    };

    // Keypad click handler
    document.querySelector(".container").addEventListener("click", async e => {
        if (e.target.classList.contains("keypad-btn")) {
            // Append digit to currentCode
            updateInput(currentCode + e.target.textContent);
        }
        if (e.target === backBtn) {
            // Remove last character
            updateInput(currentCode.slice(0, -1));
        }
        if (e.target === confirmBtn) {
            if (step === 1) {
                // Treat currentCode as player number
                const number = currentCode.trim();
                if (!number) {
                    alert("Kérem, adjon meg egy játékos sorszámot!");
                    return;
                }
                try {
                    const user = await apiFetch(`/api/users/number/${number}`);
                    if (user && (user.name || user._id)) {
                        // Before proceeding, check if player already has a log entry for this station
                        userData = user;
                        // Defensive: ensure stationData is loaded
                        if (!stationData || !stationData._id) {
                            alert("Állomás adatok nem elérhetők!");
                            resetToStep1();
                            return;
                        }
                        // Check if player already has a point log at this station
                        try {
                            const logs = await apiFetch(`/api/points/logs?playerId=${userData._id}&stationId=${stationData._id}`);
                            console.log(logs)
                            if (Array.isArray(logs) && logs.length > 0) {
                                alert("A játékos már szerepelt ezen az állomáson!");
                                resetToStep1();
                                return;
                            }
                        } catch (err) {
                            // If API fails, treat as not existing (or optionally, show error)
                            // Optionally: alert("Nem sikerült ellenőrizni a pontbejegyzést!");
                        }
                        // Step 1 → Step 2 transition: show points prompt with max points
                        document.getElementById("msg").innerText = `Add meg az elért pontot (Max: ${stationData.max_points})`;
                        currentCode = "";
                        codeInput.value = "";
                        step = 2;
                        console.log("Points" + userData.points)
                        console.log(userData)
                        // Update player info floating div and show it
                        document.getElementById("playerName").innerText = `Név: ${userData.name}`;
                        document.getElementById("playerNumber").innerText = `Sorszám: ${userData.number}`;
                        document.getElementById("playerClass").innerText = `Osztály: ${userData.class}`;
                        document.getElementById("playerPoints").innerText = `Pont: ∑ ${userData.points}`;
                        document.getElementById("playerInfo").style.left = "10px";
                    } else {
                        alert("Felhasználó nem található!");
                        resetToStep1();
                    }
                } catch (err) {
                    alert("Játékos nem található!");
                    resetToStep1();
                }
            } else if (step === 2) {
                // Treat currentCode as points
                const points = currentCode.trim();
                if (!points || isNaN(points) || points < 0 || points > stationData.max_points) {
                    alert("Kérem, adjon meg egy érvényes pontszámot!");
                    return;
                }
                try {
                    await apiFetch(`/api/points/register`, {
                        method: "POST",
                        body: JSON.stringify({
                            userNumber: userData.number,
                            stationId: stationData._id,
                            points: Number(points)
                        }),
                    });
                    codeInput.value = "✅";
                    currentCode = "";
                    step = 1;
                    userData = null;
                    document.getElementById("msg").innerText = "Kérlek add meg a játékos sorszámát!";
                    setTimeout(() => {
                        codeInput.value = "";
                    }, 2000);
                } catch (err) {
                    alert("Hiba történt! Írd fel papírra!");
                    resetToStep1();
                }
            }
        }
    });

    const initStation = async () => {
        const stationId = new URLSearchParams(window.location.search).get("id");
        if (!stationId) return;
        try {
            const data = await apiFetch(`/api/stations/${stationId}`);
            stationData = data;
            const { name, number, status, delay } = data;
            document.getElementById("stationName").innerText = name;
            document.getElementById("stationId").innerText = number;
            document.title = `${name} (#${number}) - Sorverseny`;
            document.getElementById("msg").innerText = "Kérlek add meg a játékos sorszámát!";
            document.getElementById("vbtn-radio1").checked = !status;
            document.getElementById("vbtn-radio2").checked = status;
            [keypadButtons, [confirmBtn, backBtn]].flat().forEach(btn => btn.disabled = !status);
            // Overlay logic
            const overlay = document.getElementById("keypad-closed-overlay");
            if (overlay) overlay.style.display = status ? "none" : "flex";
            // Delay radio logic
            const delayMap = [0, 5, 10, 15];
            delayRadios.forEach(r => (r.checked = parseInt(r.value) === delay));
            // Debug logging for delay values
            console.debug("[DEBUG] data.delay:", data.delay);
            console.debug("[DEBUG] stationData.delay:", stationData.delay);
            console.debug("[DEBUG] delayMap:", delayMap);
            if (!delayMap.includes(stationData.delay)) alert("Hibás várakozási idő!");
            // Initialize step 1
            resetToStep1();
        } catch (err) {
            console.error("Init station error:", err);
        }
    };

    const updateDelay = async delay => {
        try {
            await apiFetch(`/api/stations/${stationData._id}/delay`, {
                method: "PATCH",
                body: JSON.stringify({ delay }),
            });
            alert(`Késés frissítve: ${delay} perc`);
            stationData.delay = delay;
        } catch (err) {
            alert(err.message);
        }
    };

    const updateStatus = async isOpen => {
        try {
            await apiFetch(`/api/stations/${stationData._id}/status/${isOpen}`, { method: "PATCH" });
            alert(isOpen ? "Állomás kinyitva!" : "Állomás bezárva!");
            await initStation();
        } catch (err) {
            alert(err.message);
        }
    };

    // Generic event handlers for delay and status
    delayRadios.forEach(r =>
        r.addEventListener("change", e => {
            if (e.target.checked) {
                // Visually reflect
                delayRadios.forEach(r2 => r2.checked = false);
                e.target.checked = true;
                updateDelay(parseInt(e.target.value));
            }
        })
    );
    statusRadios.forEach(r =>
        r.addEventListener("change", e =>
            e.target.checked && updateStatus(e.target.id === "vbtn-radio2")
        )
    );

    (async () => { await initStation(); })();
</script>
</html>